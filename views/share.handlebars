{{> nav}}

<div class="row">
  <div class="small-8 small-offset-2 medium-6 medium-offset-3 columns">
      <div id="errorMessage" class="callout warning hidden" data-closable>
        <span><strong>{{text.common.error}}: </strong>{{text.common.errored}}</span>
        <button class="close-button" aria-label="Dismiss alert" type="button" data-close>
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div id="successMessage" class="callout success hidden" data-closable>
        <span><strong>{{text.common.success}}: </strong>{{text.share.uploaded}}</span>
        <button class="close-button" aria-label="Dismiss alert" type="button" data-close>
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
  </div>
</div>

<div class="row">
  <div class="small-8 small-offset-2 medium-6 medium-offset-3 columns box">
    <h4>{{text.share.sharePrompt}}</h4>
    <form id="upload" action="/upload" enctype="multipart/form-data" method="POST">
      <label for="vcaFile" class="button">{{text.share.fileBtn}}</label> <span id="selectedFile"></span>
      <input type="file" id="vcaFile" name="vcaFile" class="show-for-sr" accept=".doc,.docx,.pdf" aria-describedby="fileUploadHelpText" required>
      <p class="help-text" id="fileUploadHelpText">{{text.share.fileHelp}}</p>
      <label>{{text.common.type}}
        <fieldset>
          <input type="radio" name="type" value="VCA" id="VCA" required><label for="VCA">VCA</label>
          <input type="radio" name="type" value="POA" id="POA"><label for="POA">POA</label>
        </fieldset>
      </label>

      <label> {{text.share.titlePrompt}}
        <input id="title" type="text" name="title" placeholder="..." required>
      </label>
      <label> {{text.common.description}}
        <textarea id="description" type="text" name="description" placeholder="..." rows= "3" required></textarea>
      </label>
      <label>{{text.share.countryLabel}}
        <div id="search-box">
          <input class="typeahead" type="text" placeholder="{{text.share.countrysearch}}">
        </div>
        <select id="iso3" name="iso3" required>
          <option selected disabled hidden style="display:none;" value="_error">{{text.share.countryPrompt}}</option>
        </select>
      </label>
      <label>{{text.common.community}}
        <select id="community" name="community" disabled required>
          <option value="_new">{{text.share.commAdd}}</option>
          <option selected disabled hidden style="display:none;" value="_error">{{text.share.commPrompt}}</option>
        </select>
        <input id="community_new" type="text" name="community_new" placeholder="..." disabled required>
      </label>
      <label>{{text.common.year}}
        <select id="year" name="year" required>
          <option selected disabled hidden style="display:none;" value="">{{text.share.yearPrompt}}</option>
          <option value="2017">2017</option><option value="2016">2016</option><option value="2015">2015</option><option value="2014">2014</option><option value="2013">2013</option><option value="2012">2012</option><option value="2011">2011</option><option value="2010">2010</option><option value="2009">2009</option><option value="2008">2008</option><option value="2007">2007</option><option value="2006">2006</option><option value="2005">2005</option><option value="2004">2004</option><option value="2003">2003</option><option value="2002">2002</option><option value="2001">2001</option><option value="2000">2000</option><option value="1999">1999</option><option value="1998">1998</option><option value="1997">1997</option><option value="1996">1996</option><option value="1995">1995</option><option value="1994">1994</option><option value="1993">1993</option><option value="1992">1992</option><option value="1991">1991</option><option value="1990">1990</option><option value="1989">1989</option><option value="1988">1988</option>
        </select>
      </label>
      <div id="submitErrorMessage" class="callout warning hidden" data-closable>
        <span><strong>{{text.common.allFieldsErr }} </strong></span>
        <button class="close-button" aria-label="Dismiss alert" type="button" data-close>
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <button type="submit" value="submit" class="button primary form-actions__submit">{{text.common.submit}}</button>
      <button class="button secondary form-actions__clear">{{text.common.clearForm}}</button>
      <i class="fa fa-spinner fa-spin form-actions__spinner" style="font-size:32px; margin-left:12px;" aria-hidden="true"></i>
    </form>
  </div>
</div>



<script src="/js/typeahead.bundle.js" charset="utf-8"></script>
<script src="/js/handlebars-v4.0.5.js" charset="utf-8"></script>

<script>

var pageLanguage = "{{text.meta.language}}";
var emptymessage = "{{text.common.emptymessage}}"
window.onload = function() {

  // if the page loads with it hidden it won't spin when shown
  $(".form-actions__spinner").hide();

  $("#vcaFile").on('change', function() {
    $("#selectedFile").text(this.files[0].name);
  })

  $("#iso3").on('change', function() {
    $("#community").prop("disabled", true);
    $("#community").find(".community_options").remove();
    $("#community").val('_error');
    $("#community_new").val('').prop("disabled", true);

    var url = "/api/communities/" + $("#iso3").find(":selected").val();
    $.get(url, function(data) {
      for(var i=0, len=data.length; i<len; i++) {
        var html = '<option class="community_options" value="' + data[i].community + '">' + data[i].community + '</option>';
        $("#community").prepend(html);
      }
      $("#community").prop("disabled", false);
    });
  })

  $("#community").on('change', function() {
    if($("#community").val() === '_new'){
      $("#community_new").prop("disabled", false);
    } else {
      $("#community_new").prop("disabled", true);
    }
  })

  $.get("/api/countries", function(data) {
    var searchData = [];
    for(var i=0, len=data.length; i<len; i++) {
      var name = (data[i][pageLanguage] !== undefined) ? data[i][pageLanguage] : data[i]["en"];
      var html = '<option value="' + data[i].iso3 + '">' + name + '</option>';
      $("#iso3").append(html);
      searchData.push({
        'name': name,
        'iso3': data[i].iso3
      })
    }
    buildSearchBox(searchData);
  });

  clearForm = function(){
    $("#upload").find("input[type=text]").val('');
    $('input[type=radio]').attr('checked',false);
    $("#description").val('');
    $("#year").val('');
    $("#iso3").val('_error');
    $("#community").prop("disabled", true);
    $("#community_new").prop("disabled", true);
    $("#community").val('_error');
    $("#community").find(".community_options").remove();
    $("#selectedFile").empty();
    $(".form-actions__spinner").hide();
    $(".form-actions__submit").removeClass("disabled");
    $("#submitErrorMessage").hide();
    $("html, body").animate({ scrollTop: 0 }, "slow");
  }

  var upload = $("#upload");
  upload.find(".form-actions__clear").click(function(e) {
      e.preventDefault();
      clearForm();
  });
  upload.submit(function() {
    $(this).ajaxSubmit({
      beforeSubmit: function(formData) {
        var okay = true;
        for(var i=0, len=formData.length; i<len; i++) {
          if(formData[i].value === "_error") {
            okay = false;
          }
        }
        if(okay === false) {
          $("#submitErrorMessage").show();
          return false;
        } else {
          $(".form-actions__spinner").show();
          $(".form-actions__submit").addClass("disabled");
          return true;
        }
      },
      error: function(xhr) {
        $("#errorMessageText").html(xhr.status);
        $("#errorMessage").show();
        clearForm();
      },
      success: function(response) {
        if(response.type === "success"){
          $("#successMessageText").html(response.message);
          $("#successMessage").show();
        } else {
          $("#errorMessageText").html(response.message);
          $("#errorMessage").show();
        }
        clearForm();
      }
    });
    return false;
  });


  function buildSearchBox(data){
    // constructs the suggestion engine
    var countrySearch = new Bloodhound({
      datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      local: data,
      sorter: function(a, b) {
        if (a.name < b.name) {
          return -1;
        }
        else if (a.name > b.name) {
          return 1;
        }
        else return 0;

      }
    });
    // kicks off the loading/processing of `local`
    countrySearch.initialize();
    $('#search-box .typeahead').typeahead({
      // hint: true,
      highlight: true,
      minLength: 1
    },
    {
      name: 'countrySearch',
      displayKey: Handlebars.compile('\{\{name\}\}'),
      limit: 20,
      source: countrySearch.ttAdapter(),
      templates: {
        empty:[
          '<div class="empty-message">',
          '<i>' + emptymessage + '</i>',
          '</div>'
        ].join('\n'),
        suggestion: Handlebars.compile('<p>\{\{name\}\}</p>')
      }
    }).on('typeahead:selected', function (eventObj, datum) {
      selectedCountry(datum);
    });
  }

  function selectedCountry(datum) {
    $("#iso3").find('option[value=' + datum.iso3 + ']').attr('selected','selected');
    $("#iso3").trigger('change')
    $('#search-box .typeahead').typeahead('val', '');
  }

}

</script>
